A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     1


MACRO ASSEMBLER A51 V8.02b
OBJECT MODULE PLACED IN .\output\OS_CPU_A.obj
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE keilc51\OS_CPU_A.ASM SET(LARGE) DEBUG PRINT(.\output\OS_CPU_A.lst) OBJECT(
                      .\output\OS_CPU_A.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;******************************************************************************************
                             ***************
                       2     ;**                                            Small RTOS 51 
                       3     ;**                                   The Real-Time Kernel For Keil c51
                       4     ;**
                       5     ;**                                  (c) Copyright 2002-2003, chenmingji
                       6     ;**                                           All Rights Reserved
                       7     ;**
                       8     ;**                                                  V1.12.1
                       9     ;**
                      10     ;**
                      11     ;**--------------------ÎÄ¼þÐÅÏ¢------------------------------------------------------------
                             ---------------
                      12     ;**ÎÄ   ¼þ   Ãû: OS_CPU_A.ASM
                      13     ;**´´   ½¨   ÈË: ³ÂÃ÷¼Æ
                      14     ;**°æ        ±¾: V1.12.1
                      15     ;**×îºóÐÞ¸ÄÈÕÆÚ:  2002Äê2ÔÂ5ÈÕ
                      16     ;**Ãè¡¡      Êö:  Small RTOS 51 ÓëCPU(8051ÏµÁÐ)Ïà¹ØµÄ»ã±à³ÌÐò
                      17     ;**---------------------ÀúÊ·°æ±¾ÐÅÏ¢-------------------------------------------------------
                             ---------------
                      18     ;** ´´½¨ÈË: ³ÂÃ÷¼Æ
                      19     ;** °æ  ±¾:V0.50
                      20     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                      21     ;** Ãè¡¡Êö: Ô­Ê¼°æ±¾
                      22     ;**
                      23     ;**----------------------------------------------------------------------------------------
                             --------------
                      24     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      25     ;** °æ  ±¾: V1.00
                      26     ;** ÈÕ¡¡ÆÚ: 2002Äê6ÔÂ10ÈÕ
                      27     ;** Ãè¡¡Êö: Ö§³ÖÈíµÄ·ÇÆÁ±ÎÖÐ¶Ï
                      28     ;**
                      29     ;**----------------------------------------------------------------------------------------
                             --------------
                      30     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      31     ;** °æ  ±¾: V1.10.3
                      32     ;** ÈÕ¡¡ÆÚ: 2002Äê9ÔÂ16ÈÕ
                      33     ;** Ãè¡¡Êö: ÐÞ¸ÄÁËLoadCtx´úÂëÊ¹Ö®Ö´ÐÐ¸ü¿ì£¬´úÂë¸üÐ¡
                      34     ;**         
                      35     ;**----------------------------------------------------------------------------------------
                             --------------
                      36     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      37     ;** °æ  ±¾: V1.10.4
                      38     ;** ÈÕ¡¡ÆÚ: 2002Äê10ÔÂ5ÈÕ
                      39     ;** Ãè¡¡Êö: ½«OS_CPU_A.ASMºÍOS_CPU_A_task16.ASMºÏ²¢
                      40     ;**
                      41     ;**----------------------------------------------------------------------------------------
                             --------------
                      42     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      43     ;** °æ  ±¾: V1.11.0
                      44     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                      45     ;** Ãè¡¡Êö: ¸ù¾ÝÐÂ°æ±¾ÒªÇóÊ¹ÈÎÎñ¶ÑÕ»°üº¬Os_Enter_Sum£¬Ê¹ÓÅÏÈ¼¶×îµÍ
                      46     ;**         µÄÈÎÎñÖ»±£´æÉÙÁ¿¼Ä´æÆ÷£»Ôö¼Ó×¢ÊÍ
                      47     ;**----------------------------------------------------------------------------------------
                             --------------
                      48     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      49     ;** °æ  ±¾: V1.12.0
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     2

                      50     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ30ÈÕ
                      51     ;** Ãè¡¡Êö: ¸ù¾ÝÐÂ°æ±¾ÒªÇó¸ü¸ÄÉÙÁ¿´úÂë
                      52     ;**----------------------------------------------------------------------------------------
                             --------------
                      53     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      54     ;** °æ  ±¾: V1.12.1
                      55     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ5ÈÕ
                      56     ;** Ãè¡¡Êö: ¸üÕLoadCtxÖÐOS_MAX_TASKSÎª8»ò16µÄbug
                      57     ;**---------------------µ±Ç°°æ±¾ÐÞ¶©-------------------------------------------------------
                             ----------------
                      58     ;** ÐÞ¸ÄÈË:
                      59     ;** ÈÕ¡¡ÆÚ:
                      60     ;** Ãè¡¡Êö:
                      61     ;**
                      62     ;**----------------------------------------------------------------------------------------
                             --------------
                      63     ;******************************************************************************************
                             **************/
                      64     ;#include "OS_CPU.H"
                +1    65     
                +1    66     
                +1    67     
                +1    68     
                +1    69     
                +1    70     
                +1    71     
                +1    72     
                +1    73     
                +1    74     
                +1    75     
                +1    76     
                +1    77     
                +1    78     
                +1    79     
                +1    80     
                +1    81     
                +1    82     
                +1    83     
                +1    84     
                +1    85     
                +1    86     
                +1    87     
                +1    88     
                +1    89     
                +1    90     
                +1    91     
                +1    92     
                +1    93     
                +1    94     
                +1    95     
                +1    96     
                +1    97     
                +1    98     
                +1    99     
                +1   100     
                +1   101     
                +1   102     
                +1   103     
                +1   104     
                +1   105     
                +1   106     
                +1   107     
                +1   108     
                +1   109     
                +1   110     
                +1   111     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     3

                +1   112     
                +1   113     
                +1   114     
                +1   115     
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1   163     
                +1   164     
                +1   165     
                +1   166     SET_EA   MACRO                                                  ;´ò¿ªËùÓÐÔÊÐíÖÐ¶Ï
                +1   167                  SETB     EA
                +1   168              ENDM
                +1   169              
                +1   170     
                +1   171     
                +1   172     
                +1   173     
                +1   174     
                     175     
                     176     ;#include "OS_CFG.H"
                +1   177     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     4

                +1   178     
                +1   179     
                +1   180     
                +1   181     
                +1   182     
                +1   183     
                +1   184     
                +1   185     
                +1   186     
                +1   187     
                +1   188     
                +1   189     
                +1   190     
                +1   191     
                +1   192     
                +1   193     
                +1   194     
                +1   195     
                +1   196     
                +1   197     
                +1   198     
                +1   199     
                +1   200     
                +1   201     
                +1   202     
                +1   203     
                +1   204     
                +1   205     
                +1   206     
                +1   207     
                +1   208     
                +1   209     
                +1   210     
                +1   211     
                +1   212     
                +1   213     
                +1   214     
                +1   215     
                +1   216     
                +1   217     
                +1   218     
                +1   219     
                +1   220     
                +1   221     
                +1   222     
                +1   223     
                +1   224     
                +1   225     
                +1   226     
                +1   227     
                +1   228     
                +1   229     
                +1   230     
                +1   231     
                +1   232     
                +1   233     
                +1   234     
                +1   235     
                +1   236                                                 
                +1   237     
                +1   238     
                +1   239     
                +1   240     
                +1   241     
                +1   242     
                +1   243     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     5

                +1   244     
                +1   245     
                +1   246     
                +1   247     
                +1   248                                                 
                +1   249     
                +1   250     
                +1   251     
                +1   252     
                +1   253     
                +1   254     
                +1   255     
                +1   256     
                +1   257     
                +1   258     
                +1   259     
                +1   260     
                +1           
                +1           
                +1   263     
                +1           
                +1           
                +1           
                +1           
                +1           
                +1   269     
                +1   270     
                +1   271     
                +1   272     
                     273     
                     274     
                     275     
                             
                             
                     278     
                     279     
                     280     
                     281     
                     282         NAME    OS_CPU_A_ASM
                     283     
                     284     ?PR?OSCtxSw?OS_CPU_A                     SEGMENT CODE
                     285     ?PR?OSIntCtxSw?OS_CPU_A                  SEGMENT CODE
                     286     ?PR?LoadCtx?OS_CPU_A                     SEGMENT CODE
                     287     ?PR?C_OSCtxSw?OS_CPU_A                   SEGMENT CODE 
                     288     ?PR?_OSTaskStkInit?OS_CPU_A              SEGMENT CODE 
                     289     
                     290     
                     291         EXTRN   CODE (OSMapTbl)
                     292         EXTRN   DATA (OSFastSwap)
                     293         EXTRN   DATA (OSTaskID)
                     294         EXTRN   DATA (OSNextTaskID)
                     295         EXTRN   DATA (OSTsakStackBotton)
                     296         EXTRN   DATA (Os_Enter_Sum)
                     297     IF 0  <> 0
                                 EXTRN   IDATA (Sp2)
                             ENDIF
                     300     IF 0 > 0
                                 EXTRN   DATA (?C_XBP)
                             ENDIF
                     303     
                     304         PUBLIC  _OSTaskStkInit
                     305         PUBLIC  LoadCtx
                     306         PUBLIC  OSIntCtxSw
                     307         PUBLIC  OSCtxSw
                     308         PUBLIC  STACK
                     309         PUBLIC  C_OSCtxSw
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     6

                     310     
                     311     ;****************************************************************************************
                     312     ;?STACK SEGMENT IDATA
                     313     
                     314     ?STACK      SEGMENT   IDATA
                     315     
----                 316             RSEG    ?STACK
0000                 317     STACK:                                          ;¶ÑÕ»
0000                 318             DS  1
                     319     
                     320     ; /****************************************************************************************
                             *****************
                     321     ; ** º¯ÊÃû³Æ: OSTaskStkInit
                     322     ; ** ¹¦ÄÜÃèÊö: ÈÎÎñ¶ÑÕ»³õÊ¼»¯
                     323     ; ** Êä¡¡Èë: ÎÞ
                     324     ; ** Êä¡¡³ö : ÎÞ
                     325     ; ** È«¾Ö±äÁ¿: OSTaskID,OSTsakStackBotton,SP
                     326     ; ** µ÷ÓÃÄ£¿é: LoadCtx
                     327     ; ** 
                     328     ; ** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     329     ; ** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     330     ; **---------------------------------------------------------------------------------------
                             ----------------
                     331     ; ** ÐÞ¸ÄÈË:
                     332     ; ** ÈÕ¡¡ÆÚ:
                     333     ; **---------------------------------------------------------------------------------------
                             ----------------
                     334     ; *****************************************************************************************
                             ***************/
                     335      
----                 336         RSEG  ?PR?_OSTaskStkInit?OS_CPU_A
0000                 337     _OSTaskStkInit:
                     338         USING   0
                     339     ;---- Variable 'cp?147' assigned to Register 'R0' ----
                     340     ;---- Variable 'cp?146' assigned to Register 'R1' ----
                     341     ;---- Variable 'i?145' assigned to Register 'R2' ----
                     342     ;---- Variable 'TaskID?144' assigned to Register 'R3' ----
                     343     ;---- Variable 'ptos?143' assigned to Register 'R4/R5' ----
                     344         
0000 C006            345         PUSH    AR6
0002 C007            346         PUSH    AR7
                     347     ; {
                     348     
                     349     ;         OSFastSwap[0] &= ~OSMapTbl[TaskID];
0004 EB              350         MOV     A,R3
0005 900000   F      351         MOV     DPTR,#OSMapTbl
0008 93              352         MOVC    A,@A+DPTR
0009 4200     F      353         ORL     OSFastSwap,A
                             
                             
                                 
                                 
                                 
                                 
                                 
                             
                             
                                 
                                 
                                 
                             
                                 
                             
                             
                             
                             
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     7

                                 
                                 
                                 
                                 
                             
                             
                             
                     379     
                     380     ;     if (TaskID < OSRunningTaskID())
000B EB              381         MOV     A,R3
000C C3              382         CLR     C
000D 9500     F      383         SUBB    A,OSTaskID
000F 502E            384         JNC     StkInit5
                     385     ;     {
                     386     ;         i =  OSRunningTaskID() - TaskID;
0011 C3              387         CLR     C
0012 E500     F      388         MOV     A,OSTaskID
0014 9B              389         SUBB    A,R3
0015 FA              390         MOV     R2,A
                     391     ;         cp = (uint8 idata *)(&(OSTsakStackBotton[TaskID + 1]));
0016 7400     F      392         MOV     A,#LOW (OSTsakStackBotton+01H)
0018 2B              393         ADD     A,R3
0019 F9              394         MOV     R1,A
001A                 395     StkInit8:
                     396     ;         do
                     397     ;         {
                     398     ;             *cp += SP_ADD_BYTE;
001A 7403            399         MOV     A,#3
001C 27              400         ADD     A,@R1
001D F7              401         MOV     @R1,A
                     402     ;             cp++;
001E 09              403         INC     R1
                     404     ;         } while (--i != 0);
001F DAF9            405         DJNZ    R2,StkInit8
                     406     
                     407     ;         cp1 = (uint8 idata *)SP;
0021 A881            408         MOV     R0,SP
                     409     ;         SP = SP + SP_ADD_BYTE;
                     410                 ; SOURCE LINE # 172
0023 7403            411         MOV     A,#3
0025 2581            412         ADD     A,SP
0027 F581            413         MOV     SP,A
                     414     ;         i = SP - (uint8)(OSTsakStackBotton[TaskID + 1]) + 1;
0029 7400     F      415         MOV     A,#LOW (OSTsakStackBotton+01H)
002B 2B              416         ADD     A,R3
002C F9              417         MOV     R1,A
002D 8707            418         MOV     AR7,@R1
002F C3              419         CLR     C
0030 E581            420         MOV     A,SP
0032 9F              421         SUBB    A,R7
0033 FA              422         MOV     R2,A
0034 0A              423         INC     R2
                     424     ;         cp = (uint8 idata *)SP;
0035 A981            425         MOV     R1,SP
0037                 426     StkInit11:
                     427     ;         do
                     428     ;         {
                     429     ;             *cp-- = *cp1--;
0037 E6              430         MOV     A,@R0
0038 F7              431         MOV     @R1,A
0039 18              432         DEC     R0
003A 19              433         DEC     R1
                     434     ;         } while (--i != 0);
003B DAFA            435         DJNZ    R2,StkInit11
                     436     ;     }
003D 802C            437         SJMP    StkInit12
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     8

003F                 438     StkInit5:
                     439     ;     else
                     440     ;     {
                     441     ;         cp1 = (uint8 idata *)(&(OSTsakStackBotton[OSRunningTaskID() + 1]));
003F 7400     F      442         MOV     A,#LOW (OSTsakStackBotton+01H)
0041 2500     F      443         ADD     A,OSTaskID
0043 F8              444         MOV     R0,A
                     445     ;         i = TaskID - OSRunningTaskID();
0044 C3              446         CLR     C
0045 EB              447         MOV     A,R3
0046 9500     F      448         SUBB    A,OSTaskID
0048 FA              449         MOV     R2,A
0049                 450     StkInit15:
                     451     ;         do
                     452     ;         {
                     453     ;             *cp1 -= SP_ADD_BYTE;
0049 74FD            454         MOV     A,#(-3)
004B 26              455         ADD     A,@R0
004C F6              456         MOV     @R0,A
                     457     ;             cp1++;
004D 08              458         INC     R0
                     459     ;         } while (--i != 0);
004E DAF9            460         DJNZ    R2,StkInit15
                     461     ;         
                     462     ;         cp = OSTsakStackBotton[OSRunningTaskID() + 1];
0050 7400     F      463         MOV     A,#LOW (OSTsakStackBotton+01H)
0052 2500     F      464         ADD     A,OSTaskID
0054 F8              465         MOV     R0,A
0055 E6              466         MOV     A,@R0
0056 F9              467         MOV     R1,A
                     468     ;         i = OSTsakStackBotton[TaskID] - cp - SP_ADD_BYTE;
0057 E9              469         MOV     A,R1
0058 24FD            470         ADD     A,#(-3)
005A FF              471         MOV     R7,A
                     472     
005B 7400     F      473         MOV     A,#LOW (OSTsakStackBotton)
005D 2B              474         ADD     A,R3
005E F8              475         MOV     R0,A
005F E6              476         MOV     A,@R0
0060 C3              477         CLR     C
0061 9F              478         SUBB    A,R7
0062 FA              479         MOV     R2,A
                     480     ;         cp1 = cp - SP_ADD_BYTE;
0063 A807            481         MOV     R0,AR7
0065                 482     StkInit18:
                     483     ;         do
                     484     ;         {
                     485     ;             *cp1++ = *cp++;
0065 E7              486         MOV     A,@R1
0066 F6              487         MOV     @R0,A
0067 08              488         INC     R0
0068 09              489         INC     R1
                     490     ;         } while (--i != 0);
0069 DAFA            491         DJNZ    R2,StkInit18
                     492     ;     }
006B                 493     StkInit12:
                     494     ;     cp = OSTsakStackBotton[TaskID];
006B 7400     F      495         MOV     A,#LOW (OSTsakStackBotton)
006D 2B              496         ADD     A,R3
006E F8              497         MOV     R0,A
006F E6              498         MOV     A,@R0
0070 F9              499         MOV     R1,A
                     500     ;     *cp++ = (uint16)task % 256;
0071 D0E0            501         pop     ACC
0073 F7              502         MOV     @R1,A
0074 09              503         INC     R1
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE     9

                     504     ;     *cp++ = (uint16)task / 256;
0075 D0E0            505         pop     ACC
0077 F7              506         MOV     @R1,A
0078 09              507         INC     R1
                     508     
                             
                                 
                                 
                             
                                 
                                 
                             
                     516     ;     *cp = 0;
0079 E4              517         CLR     A
007A F7              518         MOV     @R1,A
                     519     ; }
007B 22              520         RET     
                     521     
                     522     ;/*****************************************************************************************
                             ****************
                     523     ;** º¯ÊÃû³Æ: LoadCtx
                     524     ;** ¹¦ÄÜÃèÊö: ÈÎÎñ»·¾³»Ö¸´º¯Ê
                     525     ;** Êä¡¡Èë: OSTaskID,OSFastSwap
                     526     ;** Êä¡¡³ö : ÎÞ
                     527     ;** È«¾Ö±äÁ¿: ÎÞ
                     528     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     529     ;** 
                     530     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     531     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     532     ;**----------------------------------------------------------------------------------------
                             ---------------
                     533     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     534     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     535     ;**----------------------------------------------------------------------------------------
                             ---------------
                     536     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     537     ;** ÈÕ¡¡ÆÚ: 2003Äê2ÔÂ5ÈÕ
                     538     ;**----------------------------------------------------------------------------------------
                             ---------------
                     539     ;** ÐÞ¡¡¸Ä:
                     540     ;** ÈÕ¡¡ÆÚ:
                     541     ;**----------------------------------------------------------------------------------------
                             ---------------
                     542     ;******************************************************************************************
                             **************/
                     543     
----                 544         RSEG  ?PR?LoadCtx?OS_CPU_A
0000                 545     LoadCtx:
                     546         USING   0
                     547        
0000 D000     F      548         POP     Os_Enter_Sum            ;»Ö¸´¹ØÖÐ¶Ï¼ÆÊÆ÷
                     549     
                     550     
                                 
                                 
                             
                     554     
                     555                                         ;ÅÐ¶ÏÊÇ·ñÐèÒª»Ö¸´ËùÓÐ¼Ä´æÆ÷
0002 E500     F      556         MOV     A,OSTaskID
0004 B40402          557         CJNE    A,#4,LoadCtx_0
0007 8022            558         SJMP    LoadCtx_2
0009                 559     LoadCtx_0:
0009 900000   F      560         MOV     DPTR,#OSMapTbl
                     561     
000C 93              562         MOVC    A,@A+DPTR
000D 5500     F      563         ANL     A,OSFastSwap
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE    10

                             
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                             
000F 701A            575         JNZ     LoadCtx_2
                     576                                         ;»Ö¸´¼Ä´æÆ÷
0011 D007            577         POP     7
0013 D006            578         POP     6
0015 D005            579         POP     5
0017 D004            580         POP     4
0019 D003            581         POP     3
001B D002            582         POP     2
001D D001            583         POP     1
001F D000            584         POP     0
0021 D0D0            585         POP     PSW
0023 D082            586         POP     DPL
0025 D083            587         POP     DPH
0027 D0F0            588         POP     B
0029 D0E0            589         POP     ACC
002B                 590     LoadCtx_2:
                     591                                         ;ÅÐ¶ÏÊÇ·ñÐèÒª¿ªÖÐ¶Ï
002B 0500     F      592         INC     Os_Enter_Sum
002D D50002   F      593         djnz    Os_Enter_Sum,LoadCtx_3
                     594         SET_EA                          ;¿ªÖÐ¶Ï
0032                 596     LoadCtx_3:
0032 22              597         RET
                     598     
                     599     
                     600     ;/*****************************************************************************************
                             ****************
                     601     ;** º¯ÊÃû³Æ: OSCtxSw
                     602     ;** ¹¦ÄÜÃèÊö: ÈÎÎñÖ÷¶¯·ÅÆúCPU»·¾³±£´æº¯Ê
                     603     ;** Êä¡¡Èë: OSTaskID
                     604     ;** Êä¡¡³ö : ÎÞ
                     605     ;** È«¾Ö±äÁ¿: OSFastSwap
                     606     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     607     ;** 
                     608     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     609     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     610     ;**----------------------------------------------------------------------------------------
                             ---------------
                     611     ;** ÐÞ¡¡¸Ä:
                     612     ;** ÈÕ¡¡ÆÚ:
                     613     ;**----------------------------------------------------------------------------------------
                             ---------------
                     614     ;******************************************************************************************
                             **************/
----                 615         RSEG  ?PR?OSCtxSw?OS_CPU_A
0000                 616     OSCtxSw:
                     617         USING   0
                     618     
                     619     
                                 
                                 
                             
                     623     
0000 C000     F      624         PUSH    Os_Enter_Sum            ;±£´æ¹ØÖÐ¶Ï¼ÆÊÆ÷
                     625                                         ;ÉèÖÃ±êÖ¾£ºÈÎÎñÔÙ´Î»Ö¸´ÔËÐÐÊ±²»±Ø»Ö¸´ËùÓÐ¼Ä´æÆ÷
0002 900000   F      626         MOV     DPTR,#OSMapTbl
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE    11

0005 E500     F      627         MOV     A,OSTaskID
                     628     
0007 93              629         MOVC    A,@A+DPTR
0008 4200     F      630         ORL     OSFastSwap,A
                             
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                             
000A 020000   F      643         LJMP    C_OSCtxSw
                     644     ;****************************************************************************************
                     645     ;/*****************************************************************************************
                             ****************
                     646     ;** º¯ÊÃû³Æ: C_OSCtxSw
                     647     ;** ¹¦ÄÜÃèÊö: ¶ÑÕ»´¦Àíº¯Ê
                     648     ;** Êä¡¡Èë: ÎÞ
                     649     ;** Êä¡¡³ö : ÎÞ
                     650     ;** È«¾Ö±äÁ¿: OSTaskID,OSTsakStackBotton,SP
                     651     ;** µ÷ÓÃÄ£¿é: LoadCtx
                     652     ;** 
                     653     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     654     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     655     ;**----------------------------------------------------------------------------------------
                             ---------------
                     656     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     657     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     658     ;**----------------------------------------------------------------------------------------
                             ---------------
                     659     ;** ÐÞ¡¡¸Ä:
                     660     ;** ÈÕ¡¡ÆÚ:
                     661     ;**----------------------------------------------------------------------------------------
                             ---------------
                     662     ;******************************************************************************************
                             **************/
----                 663         RSEG  ?PR?C_OSCtxSw?OS_CPU_A
0000                 664     C_OSCtxSw:
                     665     
0000 AA81            666         mov     r2,sp
                     667         
                     668     ;     cp1 = (unsigned char idata *)SP +1;
0002 A881            669         MOV     R0,SP
                     670     
                     671     IF 0  <> 0
                                 mov     sp,#(Sp2-1)             ;¶ÑÕ»Ö¸ÏòÁÙÊ±¿Õ¼ä£¬ÔÊÐí¡°Èí·ÇÆÁ±ÎÖÐ¶Ï¡±
                             ENDIF
                     674     
0004 08              675         INC     R0
                     676     ;     temp = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0005 7400     F      677         MOV     A,#LOW (OSTsakStackBotton+01H)
0007 2500     F      678         ADD     A,OSNextTaskID
0009 F9              679         MOV     R1,A
000A E7              680         MOV     A,@R1
000B FF              681         MOV     R7,A
                     682     ;     cp2 = OSTsakStackBotton[OSTaskID+1];
000C 7400     F      683         MOV     A,#LOW (OSTsakStackBotton+01H)
000E 2500     F      684         ADD     A,OSTaskID
0010 F9              685         MOV     R1,A
0011 E7              686         MOV     A,@R1
0012 F9              687         MOV     R1,A
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE    12

                     688     ;     if( OSNextTaskID > OSTaskID)
0013 E500     F      689         MOV     A,OSNextTaskID
0015 D3              690         SETB    C
0016 9500     F      691         SUBB    A,OSTaskID
0018 4033            692         JC      ?C0001
                     693     ;     {
                     694     ;         while(cp2 != (unsigned char idata *)temp)
                     695     ;         {
                     696     ;             *cp1++ = *cp2++;
                     697     ;         }
001A EF              698         MOV     A,R7
001B C3              699         CLR     C
001C 99              700         SUBB    A,R1
001D FE              701         MOV     R6,A
001E                 702     ?C0002:
001E E7              703         MOV     A,@R1
001F F6              704         MOV     @R0,A
0020 08              705         INC     R0
0021 09              706         INC     R1
0022 DEFA            707         DJNZ    R6,?C0002
0024                 708     ?C0003:
                     709     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
0024 7400     F      710         MOV     A,#LOW (OSTsakStackBotton+1)
0026 2500     F      711         ADD     A,OSTaskID
0028 F9              712         MOV     R1,A
0029 E7              713         MOV     A,@R1
002A D3              714         SETB    C
                     715         ;SUBB    A,sp
002B 9A              716         SUBB    A,r2
002C FF              717         MOV     R7,A
                     718     ;         SP = (unsigned char )cp1 - 1;
002D 18              719         DEC     R0;
002E 8881            720         MOV     SP,R0
                     721     ;         for(i = OSTaskID+1;i < OSNextTaskID+1; i++)
                     722     ;         {
                     723     ;             OSTsakStackBotton[i] -= temp;
                     724     ;         }
0030 E500     F      725         MOV     A,OSNextTaskID
0032 C3              726         CLR     C
0033 9500     F      727         SUBB    A,OSTaskID
0035 FE              728         MOV     R6,A
0036 600F            729         JZ      ?C0005
                     730     
0038 7400     F      731         MOV     A,#LOW (OSTsakStackBotton)
003A 2500     F      732         ADD     A,OSTaskID
003C F9              733         MOV     R1,A    
003D EF              734         MOV     A,R7
003E F4              735         CPL     A
003F 04              736         INC     A
0040 FF              737         MOV     R7,A
0041                 738     ?C0004:
0041 09              739         INC     R1
0042 EF              740         MOV     A,R7
0043 27              741         ADD     A,@R1    
0044 F7              742         MOV     @R1,A
0045 DEFA            743         DJNZ    R6,?C0004
0047                 744     ?C0005:
                     745     ;         OSTaskID = OSNextTaskID;
0047 850000   F      746         MOV     OSTaskID,OSNextTaskID
                     747     ;         LoadCtx();    
004A 020000   F      748         LJMP    LoadCtx
                     749     ;     }
004D                 750     ?C0001:
                     751     ; 
                     752     ;     if( OSNextTaskID != OSTaskID)
004D E500     F      753         MOV     A,OSNextTaskID
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE    13

004F 6500     F      754         XRL     A,OSTaskID
0051 6036            755         JZ      ?C000r
                     756     ;     {
                     757     ;          cp2--;
                     758     ;          cp1--;
                     759     ;         while(cp2 != (unsigned char idata *)temp)
                     760     ;         {
                     761     ;             *cp2-- = *cp1--;
                     762     ;         }
                     763         ;MOV     A,R7
                     764         ;CLR     C
                     765         ;SUBB    A,R1
                     766         ;MOV     R6,A
0053 E8              767         mov     a,r0
0054 C3              768         clr     c
0055 9F              769         subb    a,r7
0056 FE              770         mov     r6,a
0057                 771     ?C0008:
0057 18              772         DEC     R0
0058 19              773         DEC     R1
0059 E6              774         MOV     A,@R0
005A F7              775         MOV     @R1,A
005B DEFA            776         DJNZ    R6,?C0008
005D                 777     ?C0009:
                     778     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
005D 7400     F      779         MOV     A,#LOW (OSTsakStackBotton+01H)
005F 2500     F      780         ADD     A,OSTaskID
0061 F9              781         MOV     R1,A
0062 E7              782         MOV     A,@R1
0063 D3              783         SETB    C
                     784         ;SUBB    A,SP
0064 9A              785         SUBB    A,r2
0065 FF              786         MOV     R7,A
                     787     ;         SP = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0066 7400     F      788         MOV     A,#LOW (OSTsakStackBotton+01H)
0068 2500     F      789         ADD     A,OSNextTaskID
006A F9              790         MOV     R1,A
006B E7              791         MOV     A,@R1
006C F581            792         MOV     SP,A
                     793     ;         for(i = OSNextTaskID+1;i < OSTaskID+1; i++)
                     794     ;         {
                     795     ;             OSTsakStackBotton[i] += temp;
                     796     ;         }
                     797     
006E E500     F      798         MOV     A,OSTaskID
0070 C3              799         CLR     C
0071 9500     F      800         SUBB    A,OSNextTaskID
0073 600C            801         JZ      ?C0011
                     802     
0075 FE              803         MOV     R6,A
0076 7400     F      804         MOV     A,#LOW (OSTsakStackBotton)
0078 2500     F      805         ADD     A,OSNextTaskID
007A F9              806         MOV     R1,A    
007B                 807     ?C0010:
007B 09              808         INC     R1
007C EF              809         MOV     A,R7
007D 27              810         ADD     A,@R1    
007E F7              811         MOV     @R1,A
007F DEFA            812         DJNZ    R6,?C0010
                     813     
0081                 814     ?C0011:
                     815     ;         OSTaskID = OSNextTaskID;        
0081 850000   F      816         MOV     OSTaskID,OSNextTaskID
                     817     ;         SP--;
0084 1581            818         DEC     SP
                     819     ;     }
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE    14

0086                 820     ?C0007:
                     821     ;     LoadCtx();
0086 020000   F      822         LJMP    LoadCtx
0089                 823     ?C000r:
                     824     IF 0  <> 0
                                 mov     SP,r2
                             ENDIF
0089 020000   F      827         LJMP    LoadCtx
                     828     ;****************************************************************************************
                     829     ;/*****************************************************************************************
                             ****************
                     830     ;** º¯ÊÃû³Æ: OSIntCtxSw
                     831     ;** ¹¦ÄÜÃèÊö: ÖÐ¶ÏÊ¹ÈÎÎñ·ÅÆúCPU»·¾³±£´æº¯Ê
                     832     ;** Êä¡¡Èë: OSTaskID
                     833     ;** Êä¡¡³ö : ÎÞ
                     834     ;** È«¾Ö±äÁ¿: OSFastSwap
                     835     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     836     ;** 
                     837     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     838     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     839     ;**----------------------------------------------------------------------------------------
                             ---------------
                     840     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     841     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     842     ;**----------------------------------------------------------------------------------------
                             ---------------
                     843     ;** ÐÞ¡¡¸Ä:
                     844     ;** ÈÕ¡¡ÆÚ:
                     845     ;**----------------------------------------------------------------------------------------
                             ---------------
                     846     ;******************************************************************************************
                             **************/
----                 847         RSEG  ?PR?OSIntCtxSw?OS_CPU_A
0000                 848     OSIntCtxSw:
                     849         USING   0
                     850                                             ;ÊÇ·ñÊÇÓÅÏÈ¼¶×îµÍÈÎÎñ
0000 7404            851         MOV     A,#4
0002 6500     F      852         XRL     A,OSTaskID
0004 700F            853         JNZ     OSIntCtxSw_0
                     854                                             ;ÊÇÔò²»ÐèÒª±£´æËùÓÐ¼Ä´æÆ÷
                     855     ;SP=SP-13-4                             ;4:Á½²ãº¯Êµ÷ÓÃ¶ÑÕ»£¬13£º¼Ä´æÆ÷ÊÄ¿
0006 74EF            856         MOV     A,#(-17)
0008 2581            857         ADD     A,SP
000A F581            858         MOV     SP,A
                     859                                             ;Ìø×ªµ½OSCtxSw£¬Í¬Ê±Í¨ÖªCPUÖÐ¶Ï´¦ÀíÍê³É
000C 7400     F      860         MOV     A, #LOW  OSCtxSw
000E C0E0            861         PUSH    ACC
0010 7400     F      862         MOV     A, #HIGH OSCtxSw
0012 C0E0            863         PUSH    ACC
0014 32              864         RETI
                     865                                             ;ÐèÒª±£´æËùÓÐ¼Ä´æÆ÷
0015                 866     OSIntCtxSw_0:
                     867     ;SP=SP-4                                ;4:Á½²ãº¯Êµ÷ÓÃ¶ÑÕ»
0015 74FC            868         MOV     A,#0FCH
0017 2581            869         ADD     A,SP
0019 F581            870         MOV     SP,A
                     871                                             ;ÉèÖÃ±êÖ¾£ºÈÎÎñÔÙ´Î»Ö¸´ÔËÐÐÊ±ÐèÒª»Ö¸´ËùÓÐ¼Ä´æÆ÷
001B 900000   F      872         MOV     DPTR,#OSMapTbl
001E E500     F      873         MOV     A,OSTaskID
                     874     
0020 93              875         MOVC    A,@A+DPTR
0021 F4              876         CPL     A
0022 5200     F      877         ANL     OSFastSwap,A
                             
                                 
                                 
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE    15

                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                                 
                             
                             
                     893     
                     894     
                                 
                                 
                             
0024 C000     F      898         PUSH    Os_Enter_Sum            ;±£´æ¹ØÖÐ¶Ï¼ÆÊÆ÷
                     899                                             ;Ìø×ªµ½¶ÑÕ»´¦Àí£¬Í¬Ê±Í¨ÖªCPUÖÐ¶Ï´¦ÀíÍê³É
0026 7400     F      900         MOV     A, #LOW  C_OSCtxSw
0028 C0E0            901         PUSH    ACC
002A 7400     F      902         MOV     A, #HIGH C_OSCtxSw
002C C0E0            903         PUSH    ACC
002E 32              904         RETI
                     905     
                     906     ;/*****************************************************************************************
                             ****************
                     907     ;**                            End Of File
                     908     ;******************************************************************************************
                             **************/
                     909         END
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/19/2013 23:42:42 PAGE    16

SYMBOL TABLE LISTING
------ ----- -------


N A M E                      T Y P E  V A L U E   ATTRIBUTES

?C0001. . . . . . . . . . .  C ADDR   004DH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0002. . . . . . . . . . .  C ADDR   001EH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0003. . . . . . . . . . .  C ADDR   0024H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0004. . . . . . . . . . .  C ADDR   0041H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0005. . . . . . . . . . .  C ADDR   0047H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0007. . . . . . . . . . .  C ADDR   0086H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0008. . . . . . . . . . .  C ADDR   0057H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0009. . . . . . . . . . .  C ADDR   005DH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C000R. . . . . . . . . . .  C ADDR   0089H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0010. . . . . . . . . . .  C ADDR   007BH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0011. . . . . . . . . . .  C ADDR   0081H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?PR?C_OSCTXSW?OS_CPU_A. . .  C SEG    008CH       REL=UNIT
?PR?LOADCTX?OS_CPU_A. . . .  C SEG    0033H       REL=UNIT
?PR?OSCTXSW?OS_CPU_A. . . .  C SEG    000DH       REL=UNIT
?PR?OSINTCTXSW?OS_CPU_A . .  C SEG    002FH       REL=UNIT
?PR?_OSTASKSTKINIT?OS_CPU_A  C SEG    007CH       REL=UNIT
?STACK. . . . . . . . . . .  I SEG    0001H       REL=UNIT
ACC . . . . . . . . . . . .  D ADDR   00E0H   A   
AR6 . . . . . . . . . . . .  D ADDR   0006H   A   
AR7 . . . . . . . . . . . .  D ADDR   0007H   A   
B . . . . . . . . . . . . .  D ADDR   00F0H   A   
C_OSCTXSW . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
DPH . . . . . . . . . . . .  D ADDR   0083H   A   
DPL . . . . . . . . . . . .  D ADDR   0082H   A   
EA. . . . . . . . . . . . .  B ADDR   00A8H.7 A   
LOADCTX . . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_0 . . . . . . . . .  C ADDR   0009H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_2 . . . . . . . . .  C ADDR   002BH   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_3 . . . . . . . . .  C ADDR   0032H   R   SEG=?PR?LOADCTX?OS_CPU_A
OSCTXSW . . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSCTXSW?OS_CPU_A
OSFASTSWAP. . . . . . . . .  D ADDR   -----       EXT
OSINTCTXSW. . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSINTCTXSW_0. . . . . . . .  C ADDR   0015H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSMAPTBL. . . . . . . . . .  C ADDR   -----       EXT
OSNEXTTASKID. . . . . . . .  D ADDR   -----       EXT
OSTASKID. . . . . . . . . .  D ADDR   -----       EXT
OSTSAKSTACKBOTTON . . . . .  D ADDR   -----       EXT
OS_CPU_A_ASM. . . . . . . .  N NUMB   -----       
OS_ENTER_SUM. . . . . . . .  D ADDR   -----       EXT
PSW . . . . . . . . . . . .  D ADDR   00D0H   A   
SP. . . . . . . . . . . . .  D ADDR   0081H   A   
STACK . . . . . . . . . . .  I ADDR   0000H   R   SEG=?STACK
STKINIT11 . . . . . . . . .  C ADDR   0037H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT12 . . . . . . . . .  C ADDR   006BH   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT15 . . . . . . . . .  C ADDR   0049H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT18 . . . . . . . . .  C ADDR   0065H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT5. . . . . . . . . .  C ADDR   003FH   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT8. . . . . . . . . .  C ADDR   001AH   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
_OSTASKSTKINIT. . . . . . .  C ADDR   0000H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
